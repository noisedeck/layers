<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layers - Media Editor</title>
    <meta name="description" content="Layer-based media editor powered by the Noisemaker shader pipeline.">
    <meta name="keywords" content="layers, media, editor, shader, effects, blend modes">
    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#333333">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Layers">
    <link rel="apple-touch-icon" href="/img/icon-192.svg">
    <!-- Preload fonts -->
    <link rel="preload" href="/fonts/Nunito.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/CormorantUpright-SemiBold.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="https://fonts.noisedeck.app/fonts/nunito/Nunito[wght].woff2" as="font" type="font/woff2" crossorigin>
    <link rel="stylesheet" href="css/fonts.css">
    <link rel="stylesheet" href="css/colors.css">
    <link rel="stylesheet" href="css/menu.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/layers.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/loading.css">
    <link rel="stylesheet" href="css/selection.css">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-modal">
            <div class="loading-brand">
                <svg class="loading-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 600" fill="currentColor">
                    <g transform="translate(0,600) scale(0.1,-0.1)">
                        <path d="M840 5478 c-10 -18 -120 -204 -244 -413 l-225 -380 1314 -3 c723 -1 1907 -1 2630 0 l1315 3 -236 390 c-130 215 -241 400 -247 413 l-10 22 -2139 0 -2139 0 -19 -32z"/>
                        <path d="M659 4118 c-111 -189 -222 -376 -246 -415 l-43 -73 2630 0 2630 0 -249 413 -249 412 -2135 3 -2135 2 -203 -342z"/>
                        <path d="M858 3403 c-8 -10 -90 -146 -183 -303 -92 -157 -199 -337 -237 -400 l-68 -115 1315 -3 c723 -1 1907 -1 2630 0 l1314 3 -251 418 -251 417 -2127 0 c-2013 0 -2128 -1 -2142 -17z"/>
                        <path d="M619 1959 c-134 -226 -245 -414 -247 -418 -1 -3 1179 -6 2623 -6 1743 0 2625 3 2625 10 0 6 -110 192 -244 415 l-244 405 -2135 3 -2134 2 -244 -411z"/>
                        <path d="M714 1073 c-81 -137 -191 -322 -245 -413 l-99 -165 1315 -3 c723 -1 1906 -1 2629 0 l1315 3 -248 410 -247 410 -2137 3 -2136 2 -147 -247z"/>
                    </g>
                </svg>
                <h1 class="loading-title"><span>Layers</span></h1>
                <p class="loading-tagline">Media Editor</p>
                <div class="loading-status">
                    <div class="loading-spinner"></div>
                    <span>Initializing</span>
                </div>
            </div>
        </div>
    </div>

    <div id="app">
        <!-- Menu Bar -->
        <div id="menu">
            <div id="menuBackdrop"></div>
            <div id="menuLeft">
                <!-- Logo Menu -->
                <div class="menu">
                    <div class="menu-title">
                        <svg id="logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 600" fill="currentColor" style="height: 1.25em; width: 1.25em;">
                            <g transform="translate(0,600) scale(0.1,-0.1)">
                                <path d="M840 5478 c-10 -18 -120 -204 -244 -413 l-225 -380 1314 -3 c723 -1 1907 -1 2630 0 l1315 3 -236 390 c-130 215 -241 400 -247 413 l-10 22 -2139 0 -2139 0 -19 -32z"/>
                                <path d="M659 4118 c-111 -189 -222 -376 -246 -415 l-43 -73 2630 0 2630 0 -249 413 -249 412 -2135 3 -2135 2 -203 -342z"/>
                                <path d="M858 3403 c-8 -10 -90 -146 -183 -303 -92 -157 -199 -337 -237 -400 l-68 -115 1315 -3 c723 -1 1907 -1 2630 0 l1314 3 -251 418 -251 417 -2127 0 c-2013 0 -2128 -1 -2142 -17z"/>
                                <path d="M619 1959 c-134 -226 -245 -414 -247 -418 -1 -3 1179 -6 2623 -6 1743 0 2625 3 2625 10 0 6 -110 192 -244 415 l-244 405 -2135 3 -2134 2 -244 -411z"/>
                                <path d="M714 1073 c-81 -137 -191 -322 -245 -413 l-99 -165 1315 -3 c723 -1 1906 -1 2629 0 l1315 3 -248 410 -247 410 -2137 3 -2136 2 -147 -247z"/>
                            </g>
                        </svg>
                    </div>
                    <div class="menu-items hide">
                        <div id="aboutMenuItem">about Layers</div>
                    </div>
                </div>

                <!-- File Menu -->
                <div class="menu">
                    <div class="menu-title">file</div>
                    <div class="menu-items hide">
                        <div id="newMenuItem">new...</div>
                        <div id="openMenuItem">open...</div>
                        <hr class="menu-seperator">
                        <div id="saveProjectMenuItem">save project</div>
                        <div id="saveProjectAsMenuItem">save project as...</div>
                        <div id="loadProjectMenuItem">load project...</div>
                        <hr class="menu-seperator">
                        <div id="savePngMenuItem">quick save as png</div>
                        <div id="saveJpgMenuItem">quick save as jpg</div>
                        <hr class="menu-seperator">
                        <div id="exportImageMenuItem">export image...</div>
                        <div id="exportVideoMenuItem">export video...</div>
                    </div>
                </div>

                <!-- Edit Menu -->
                <div class="menu">
                    <div class="menu-title">edit</div>
                    <div class="menu-items hide">
                        <div id="undoMenuItem" class="disabled">undo<span class="menu-shortcut">&#8984;Z</span></div>
                        <div id="redoMenuItem" class="disabled">redo<span class="menu-shortcut">&#8984;&#8679;Z</span></div>
                    </div>
                </div>

                <!-- Image Menu -->
                <div class="menu" id="imageMenu">
                    <div class="menu-title">image</div>
                    <div class="menu-items hide">
                        <div id="cropToSelectionMenuItem" class="disabled">crop to selection</div>
                        <hr class="menu-seperator">
                        <div id="imageSizeMenuItem">image size...</div>
                        <div id="canvasSizeMenuItem">canvas size...</div>
                        <hr class="menu-seperator">
                        <div id="invertMenuItem">invert</div>
                        <div id="brightnessContrastMenuItem">brightness/contrast</div>
                        <div id="hueSaturationMenuItem">hue/saturation</div>
                        <hr class="menu-seperator">
                        <div id="gradientPaletteMenuItem">gradient palette</div>
                        <div id="cosinePaletteMenuItem">cosine palette</div>
                        <div id="colorGradingMenuItem">color grading</div>
                        <hr class="menu-seperator">
                        <div id="blurMenuItem">blur</div>
                    </div>
                </div>

                <!-- Layer Menu -->
                <div class="menu">
                    <div class="menu-title">layer</div>
                    <div class="menu-items hide">
                        <div id="duplicateLayerMenuItem" class="disabled">duplicate layer</div>
                        <div id="deleteLayerMenuItem" class="disabled">delete layer</div>
                        <hr class="menu-seperator">
                        <div id="layerActionMenuItem">flatten image</div>
                        <hr class="menu-seperator">
                        <div id="deselectAllLayersMenuItem">deselect all layers</div>
                    </div>
                </div>

                <!-- Select Menu -->
                <div class="menu">
                    <div class="menu-title">select</div>
                    <div class="menu-items hide">
                        <div id="selectAllMenuItem">select all<span class="menu-shortcut">&#8984;A</span></div>
                        <div id="selectNoneMenuItem" class="disabled">select none<span class="menu-shortcut">&#8984;D</span></div>
                        <div id="selectInverseMenuItem" class="disabled">select inverse<span class="menu-shortcut">&#8984;&#8679;I</span></div>
                        <hr class="menu-seperator">
                        <div id="colorRangeMenuItem">color range...</div>
                        <hr class="menu-seperator">
                        <div id="borderSelectionMenuItem" class="disabled">border...</div>
                        <div id="smoothSelectionMenuItem" class="disabled">smooth...</div>
                        <div id="expandSelectionMenuItem" class="disabled">expand...</div>
                        <div id="contractSelectionMenuItem" class="disabled">contract...</div>
                        <div id="featherSelectionMenuItem" class="disabled">feather...</div>
                    </div>
                </div>

                <!-- View Menu -->
                <div class="menu">
                    <div class="menu-title">view</div>
                    <div class="menu-items hide">
                        <div id="zoomInMenuItem">zoom in</div>
                        <div id="zoomOutMenuItem">zoom out</div>
                        <hr class="menu-seperator">
                        <div id="fitInWindowMenuItem" class="checked">fit in window</div>
                        <hr class="menu-seperator">
                        <div id="zoom50MenuItem">50%</div>
                        <div id="zoom100MenuItem">100% (actual size)</div>
                        <div id="zoom200MenuItem">200%</div>
                    </div>
                </div>

            </div>

            <div id="menuRight">
                <button id="playPauseBtn" class="menu-icon-btn icon-material" title="Play/Pause (Space)">pause</button>
            </div>
        </div>

        <!-- Toolbar -->
        <div id="toolbar">
            <div id="toolbarBackdrop"></div>
            <div class="menu" id="selectionMenu">
                <div class="menu-title menu-icon-btn" id="selectionToolBtn" title="Selection Tool">
                    <svg id="selectionToolIcon" class="selection-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1" stroke-dasharray="1 2" stroke-linecap="round">
                        <rect x="2" y="4" width="16" height="12"/>
                    </svg>
                </div>
                <div class="menu-items hide">
                    <div id="selectRectMenuItem" class="checked">
                        <svg class="selection-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1" stroke-dasharray="1 2" stroke-linecap="round">
                            <rect x="2" y="4" width="16" height="12"/>
                        </svg>
                        Box
                    </div>
                    <div id="selectOvalMenuItem">
                        <svg class="selection-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1" stroke-dasharray="1 2" stroke-linecap="round">
                            <ellipse cx="10" cy="10" rx="8" ry="6"/>
                        </svg>
                        Oval
                    </div>
                    <div id="selectLassoMenuItem">
                        <svg class="selection-icon" width="20" height="20" viewBox="0 0 1280 1280" fill="none" stroke="currentColor" stroke-width="64" stroke-dasharray="64 128" stroke-linecap="round">
                            <path transform="translate(0,1280) scale(1,-1)" d="M854 1221 c-21 -15 -48 -38 -58 -50 -24 -26 -51 -27 -107 -1 -62 28 -120 26 -148 -4 -21 -22 -22 -30 -16 -102 6 -73 5 -82 -17 -114 -30 -44 -68 -50 -134 -20 -72 33 -104 35 -137 10 -87 -69 -65 -144 60 -201 100 -45 115 -92 52 -163 -24 -27 -40 -36 -77 -41 -67 -9 -100 -24 -122 -55 -44 -62 -30 -134 37 -189 42 -35 75 -39 139 -17 47 17 201 31 237 22 13 -3 36 -23 51 -44 22 -32 26 -49 26 -104 0 -51 5 -71 21 -92 57 -73 267 13 330 135 30 59 26 140 -11 218 l-31 64 23 25 c20 21 29 23 71 18 42 -4 51 -2 79 23 26 23 32 36 35 82 5 63 -18 117 -57 136 -14 7 -48 13 -77 13 -43 0 -55 4 -71 25 -33 42 -10 90 61 126 55 29 63 53 48 151 -7 45 -19 94 -27 109 -37 73 -113 90 -180 40z"/>
                        </svg>
                        Lasso
                    </div>
                    <div id="selectPolygonMenuItem">
                        <svg class="selection-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1" stroke-dasharray="1 2" stroke-linecap="round">
                            <polygon points="10,2 18,8 15,18 5,18 2,8"/>
                        </svg>
                        Polygon
                    </div>
                    <div id="selectWandMenuItem">
                        <span class="icon-material">auto_fix_high</span>
                        Magic Wand
                    </div>
                    <hr class="menu-seperator">
                    <div id="wandToleranceRow" class="menu-slider-row hide">
                        <label>Tolerance</label>
                        <input type="range" id="wandTolerance" min="0" max="255" value="32">
                        <span id="wandToleranceValue">32</span>
                    </div>
                </div>
            </div>
            <button id="moveToolBtn" class="menu-icon-btn" title="Move Tool"><span class="icon-material">drag_pan</span></button>
            <button id="cloneToolBtn" class="menu-icon-btn" title="Clone Tool"><span class="icon-material">approval</span></button>
            <div class="toolbar-separator"></div>
            <button id="textToolBtn" class="menu-icon-btn" title="Add Text Layer"><span class="icon-material">text_fields</span></button>
        </div>

        <!-- Canvas Panel -->
        <div id="canvas-panel">
            <div class="canvas-container">
                <canvas id="canvas" width="1024" height="1024"></canvas>
                <canvas id="selectionOverlay" width="1024" height="1024"></canvas>
            </div>
        </div>

        <!-- Layers Panel -->
        <div id="layers-panel">
            <div class="layers-header">
                <h2>Layers</h2>
                <div class="layers-header-buttons">
                    <button class="add-layer-btn" id="addLayerBtn" title="Add layer">
                        <span class="icon-material">add</span>
                    </button>
                </div>
            </div>
            <div class="layers-list">
                <layer-stack></layer-stack>
            </div>
        </div>
    </div>

    <!-- Export Video Dialog -->
    <dialog id="exportModal" aria-labelledby="exportModalTitle">
        <div class="export-modal-title">
            <span class="material-symbols-outlined" style="font-size: 18px;">movie</span>
            <span id="exportModalTitle">Export Video</span>
            <button class="export-modal-close" id="exportCancelBtn">&#10005;</button>
        </div>
        <div id="exportDialogView" class="export-modal-content">
            <div class="export-settings-grid">
                <div class="control-group">
                    <label for="exportWidth" class="control-label">Width</label>
                    <input type="number" id="exportWidth" value="1024" min="64" max="4096" step="1">
                </div>
                <div class="control-group">
                    <label for="exportHeight" class="control-label">Height</label>
                    <input type="number" id="exportHeight" value="1024" min="64" max="4096" step="1">
                </div>
                <div class="control-group">
                    <label for="exportFramerate" class="control-label">Framerate</label>
                    <select id="exportFramerate">
                        <option value="24">24 fps</option>
                        <option value="30" selected>30 fps</option>
                        <option value="60">60 fps</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="exportDuration" class="control-label">Duration (sec)</label>
                    <input type="number" id="exportDuration" value="15" min="1" max="300" step="0.5">
                </div>
                <div class="control-group">
                    <label for="exportLoopCount" class="control-label">Loop Count</label>
                    <input type="number" id="exportLoopCount" value="1" min="1" max="10" step="1">
                </div>
                <div class="control-group">
                    <label for="exportFormat" class="control-label">Format</label>
                    <select id="exportFormat">
                        <option value="mp4" selected>MP4</option>
                        <option value="zip">ZIP (frames)</option>
                    </select>
                </div>
                <div class="control-group full-width">
                    <label for="exportQuality" class="control-label">Video Quality</label>
                    <select id="exportQuality">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="very high" selected>Very High</option>
                        <option value="ultra">Ultra</option>
                    </select>
                </div>
                <div class="control-group full-width">
                    <label for="exportPlayFrom" class="control-label">Play From</label>
                    <select id="exportPlayFrom">
                        <option value="beginning" selected>Beginning (reset state)</option>
                        <option value="current">Current position</option>
                    </select>
                </div>
            </div>
            <div class="export-info-row">
                <div>Total: <span id="exportTotalFrames">450 frames</span></div>
                <div>Est. size: <span id="exportEstimatedSize">~12 MB</span></div>
            </div>
            <div class="export-warning-row">
                Video layers use best-effort frame seeking. Exported frames may vary slightly from live preview.
            </div>
            <div class="export-button-row">
                <button class="export-btn export-btn--primary" id="exportBeginBtn">Begin Export</button>
            </div>
        </div>
        <div id="exportProgressView" class="export-modal-content" style="display: none;">
            <div class="export-progress-container">
                <div class="export-progress-bar-container">
                    <div class="export-progress-bar" id="exportProgressBar"></div>
                </div>
                <div class="export-progress-text" id="exportProgressText">Frame 0 of 450</div>
                <div class="export-progress-time">
                    <div>Elapsed: <span id="exportProgressElapsed">0:00</span></div>
                    <div>Remaining: <span id="exportProgressRemaining">--:--</span></div>
                </div>
                <button class="export-progress-cancel" id="exportProgressCancelBtn">Cancel Export</button>
            </div>
        </div>
    </dialog>

    <!-- Export Image Dialog -->
    <dialog id="exportImageModal" aria-labelledby="exportImageModalTitle">
        <div class="export-modal-title">
            <span class="material-symbols-outlined" style="font-size: 18px;">image</span>
            <span id="exportImageModalTitle">Export Image</span>
            <button class="export-modal-close" id="exportImageCancelBtn">&#10005;</button>
        </div>
        <div class="export-modal-content">
            <div class="export-settings-grid">
                <div class="control-group">
                    <label for="exportImageWidth" class="control-label">Width</label>
                    <input type="number" id="exportImageWidth" value="1024" min="64" max="8192" step="1">
                </div>
                <div class="control-group">
                    <label for="exportImageHeight" class="control-label">Height</label>
                    <input type="number" id="exportImageHeight" value="1024" min="64" max="8192" step="1">
                </div>
                <div class="control-group">
                    <label for="exportImageFormat" class="control-label">Format</label>
                    <select id="exportImageFormat">
                        <option value="png" selected>PNG</option>
                        <option value="jpg">JPEG</option>
                        <option value="webp">WebP</option>
                    </select>
                </div>
                <div class="control-group" id="exportImageQualityGroup">
                    <label for="exportImageQuality" class="control-label">Quality</label>
                    <select id="exportImageQuality">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high" selected>High</option>
                        <option value="very high">Very High</option>
                        <option value="maximum">Maximum</option>
                    </select>
                </div>
            </div>
            <div class="export-button-row">
                <button class="export-btn export-btn--primary" id="exportImageBeginBtn">Export</button>
            </div>
        </div>
    </dialog>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script type="module" src="js/app.js"></script>
</body>
</html>
