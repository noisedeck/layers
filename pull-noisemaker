#!/usr/bin/env python3
"""
Pull noisemaker from GitHub, build bundles, and copy to vendor directory.

This script clones the noisemaker repository, builds the ESM bundles,
and copies the necessary files to the vendor directory for Effect Workspace.

Usage:
    ./pull-noisemaker                    # Clone from default branch
    NOISEMAKER_SHA=abc123 ./pull-noisemaker  # Clone specific commit
"""
import os
import shutil
import subprocess
import tempfile
import sys

REPO_URL = "https://github.com/noisedeck/noisemaker.git"
VENDOR_DIR = "public/js/noisemaker/vendor"

def get_authenticated_url(url):
    """Inject GitHub token into URL if present in environment."""
    token = os.environ.get("GITHUB_TOKEN")
    if token and url.startswith("https://github.com/"):
        return url.replace("https://github.com/", f"https://x-access-token:{token}@github.com/")
    return url


def main():
    # Create temporary directory
    with tempfile.TemporaryDirectory() as tmpdir:
        print(f"Cloning noisemaker into {tmpdir}...")
        
        target_sha = os.environ.get("NOISEMAKER_SHA")
        auth_url = get_authenticated_url(REPO_URL)
        
        if target_sha:
            print(f"Fetching specific commit: {target_sha}")
            os.makedirs(tmpdir, exist_ok=True)
            subprocess.run(["git", "init"], cwd=tmpdir, check=True)
            subprocess.run(["git", "remote", "add", "origin", auth_url], cwd=tmpdir, check=True)
            subprocess.run(["git", "fetch", "--depth=1", "origin", target_sha], cwd=tmpdir, check=True)
            subprocess.run(["git", "checkout", "FETCH_HEAD"], cwd=tmpdir, check=True)
        else:
            # Clone the repository
            subprocess.run(
                ["git", "clone", "--depth=1", auth_url, tmpdir],
                check=True
            )
        
        print("Installing dependencies...")
        subprocess.run(
            ["npm", "install"],
            cwd=tmpdir,
            check=True
        )
        
        print("Building shader bundles...")
        subprocess.run(
            ["npm", "run", "bundle:shaders"],
            cwd=tmpdir,
            check=True
        )
        
        print(f"Copying bundles to {VENDOR_DIR}...")
        
        # Create vendor directory
        os.makedirs(VENDOR_DIR, exist_ok=True)
        
        # Copy ESM bundles (minified for production, non-minified for local dev)
        esm_bundle = os.path.join(tmpdir, "dist/shaders/noisemaker-shaders-core.esm.js")
        esm_min_bundle = os.path.join(tmpdir, "dist/shaders/noisemaker-shaders-core.esm.min.js")
        shutil.copy(esm_bundle, os.path.join(VENDOR_DIR, "noisemaker-shaders-core.esm.js"))
        shutil.copy(esm_min_bundle, os.path.join(VENDOR_DIR, "noisemaker-shaders-core.esm.min.js"))
        print(f"  [OK] noisemaker-shaders-core.esm.js (local dev)")
        print(f"  [OK] noisemaker-shaders-core.esm.min.js (production)")
        
        # Copy effects directory (pre-built bundles with inlined shaders)
        effects_src = os.path.join(tmpdir, "dist/effects")
        effects_dest = os.path.join(VENDOR_DIR, "effects")
        if os.path.exists(effects_dest):
            shutil.rmtree(effects_dest)
        shutil.copytree(effects_src, effects_dest)
        print(f"  [OK] effects/")
        
        # Copy manifest if it exists
        manifest_src = os.path.join(tmpdir, "shaders/effects/manifest.json")
        if os.path.exists(manifest_src):
            shutil.copy(manifest_src, os.path.join(effects_dest, "manifest.json"))
            print(f"  [OK] effects/manifest.json")

    print("Done!")
    return 0


if __name__ == "__main__":
    sys.exit(main())
