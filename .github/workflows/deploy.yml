name: Deploy

on:
  push:
    branches:
      - main

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Run pull-noisemaker
        run: python3 pull-noisemaker

      - name: Generate deployment metadata
        run: |
          GIT_HASH=$(git rev-parse HEAD)
          DEPLOY_DATE=$(date -u +"%s")
          printf '{\n  "git_hash": "%s",\n  "date": %s\n}\n' "$GIT_HASH" "$DEPLOY_DATE" > "$GITHUB_WORKSPACE/public/deployment-meta.json"

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SCAFFOLD_SSH_KEY }}" | base64 -d > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan ${{ secrets.SCAFFOLD_SERVER_IP }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy to scaffold
        run: |
          rsync -avz --delete \
            public/ \
            deploy@${{ secrets.SCAFFOLD_SERVER_IP }}:~/sites/layers.noisefactor.io/content/
